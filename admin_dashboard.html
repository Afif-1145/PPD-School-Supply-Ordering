<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard (Admin)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to bottom, #e3f0ff 0%, #f0f7ff 100%);
      font-family: 'Poppins', 'Segoe UI', Arial, sans-serif;
      margin: 0; padding: 0; min-height: 100vh; position: relative; overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
      background: 
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320" preserveAspectRatio="none"><path fill="%231976d2" fill-opacity="0.05" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,138.7C960,139,1056,117,1152,112C1248,107,1344,117,1392,122.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') bottom center / 100% 250px no-repeat,
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320" preserveAspectRatio="none"><path fill="%2343a047" fill-opacity="0.04" d="M0,160L48,170.7C96,181,192,203,288,197.3C384,192,480,160,576,149.3C672,139,768,149,864,165.3C960,181,1056,203,1152,197.3C1248,192,1344,160,1392,144L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') bottom center / 100% 200px no-repeat;
      animation: wave-animation 15s ease-in-out infinite;
    }
    
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
      background: 
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320" preserveAspectRatio="none"><path fill="%2342a5f5" fill-opacity="0.06" d="M0,64L48,80C96,96,192,128,288,128C384,128,480,96,576,90.7C672,85,768,107,864,122.7C960,139,1056,149,1152,138.7C1248,128,1344,96,1392,80L1440,64L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z"></path></svg>') top center / 100% 200px no-repeat,
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320" preserveAspectRatio="none"><path fill="%2366bb6a" fill-opacity="0.04" d="M0,96L48,106.7C96,117,192,139,288,138.7C384,139,480,117,576,101.3C672,85,768,75,864,90.7C960,107,1056,149,1152,154.7C1248,160,1344,128,1392,112L1440,96L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z"></path></svg>') top center / 100% 180px no-repeat;
      animation: wave-animation-reverse 18s ease-in-out infinite;
    }
    
    @keyframes wave-animation {
      0%, 100% { transform: translateX(0) translateY(0); }
      25% { transform: translateX(-2%) translateY(-3px); }
      50% { transform: translateX(0) translateY(-5px); }
      75% { transform: translateX(2%) translateY(-3px); }
    }
    
    @keyframes wave-animation-reverse {
      0%, 100% { transform: translateX(0) translateY(0); }
      25% { transform: translateX(2%) translateY(3px); }
      50% { transform: translateX(0) translateY(5px); }
      75% { transform: translateX(-2%) translateY(3px); }
    }

    .container { max-width: 900px; margin: 60px auto; background: #fff; border-radius: 24px; box-shadow: 0 10px 40px rgba(25,118,210,0.15), 0 3px 12px rgba(0,0,0,0.08); padding: 36px; position: relative; overflow: hidden; z-index: 5; animation: fadeInUp 0.6s ease-out; }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h2 { text-align: center; color: #1976d2; margin-bottom: 32px; font-size: 28px; position: relative; z-index: 1; font-weight: 700; letter-spacing: -0.5px; }
    h3 { color: #1976d2; margin-bottom: 12px; font-size: 20px; font-weight: 600; }

    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    table th, table td { border: 1px solid #e3f0ff; padding: 8px 12px; text-align: left; }
    table th { background: #e3f0ff; color: #1976d2; font-weight: 600; }

    .btn { display: inline-block; color: #fff; text-align: center; padding: 6px 12px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .btn-approve { background: linear-gradient(90deg,#43a047 60%,#66bb6a 100%);}
    .btn-reject { background: linear-gradient(90deg,#e53935 60%,#ff7043 100%);}
    .btn-undo { background: linear-gradient(90deg,#1976d2 60%,#42a5f5 100%);}
    .btn-add { background: linear-gradient(90deg,#43a047 60%,#66bb6a 100%);}
    .btn-delete { background: linear-gradient(90deg,#e53935 60%,#ff7043 100%);}
    .btn-approve:hover { background: linear-gradient(90deg,#388e3c 60%,#43a047 100%);}
    .btn-reject:hover { background: linear-gradient(90deg,#b71c1c 60%,#e53935 100%);}
    .btn-undo:hover { background: linear-gradient(90deg,#125ea2 60%,#1976d2 100%);}
    .btn-add:hover { background: linear-gradient(90deg,#388e3c 60%,#43a047 100%);}
    .btn-delete:hover { background: linear-gradient(90deg,#b71c1c 60%,#e53935 100%);}
    .link { display: inline-block; margin-top: 12px; color: #1976d2; text-decoration: none; font-weight: 500; }
    .link:hover { text-decoration: underline; color: #125ea2; }
    #resetContainer { text-align: right; margin-bottom: 24px; display: none; }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .container { 
        margin: 20px 10px; 
        padding: 20px 12px; 
        border-radius: 16px;
      }
      h2 { 
        font-size: 22px; 
        margin-bottom: 24px;
      }
      h3 { 
        font-size: 18px; 
        margin-top: 20px;
      }
      table { 
        font-size: 12px;
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      table th, table td { 
        padding: 6px 4px;
        font-size: 11px;
      }
      .btn { 
        padding: 8px 10px; 
        font-size: 12px;
        margin: 2px;
        display: inline-block;
        min-height: 32px;
      }
      .btn-delete-order {
        display: block;
        width: 100%;
        margin-top: 4px;
      }
    }

    @media (max-width: 480px) {
      .container {
        margin: 10px 5px;
        padding: 16px 8px;
      }
      h2 {
        font-size: 20px;
      }
      h3 {
        font-size: 16px;
      }
      table {
        font-size: 10px;
      }
      table th, table td {
        padding: 4px 2px;
      }
      .btn {
        padding: 6px 8px;
        font-size: 11px;
      }
    }

    /* Loading indicator styles */
    .loading {
      display: inline-block;
      margin-left: 8px;
      color: #1976d2;
      font-size: 14px;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e3f0ff;
      border-top: 4px solid #1976d2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 20px;
      color: #1976d2;
      font-weight: 600;
      font-size: 16px;
    }
    
    .table-loading {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Memuat data...</div>
  </div>
  
  <main class="container">
    <h2>PPD - Dashboard</h2>
    
    <!-- Refresh Data Section -->
    <div style="text-align: right; margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 8px;">
      <button id="refreshDataBtn" class="btn btn-approve" style="margin-right: 10px;">üîÑ Segarkan Data</button>
      <label style="display: inline-block; margin-left: 10px;">
        <input type="checkbox" id="autoRefreshToggle"> Auto-refresh (30s)
      </label>
    </div>

    <!-- Pesanan Terkini -->
    <h3>Pesanan Terkini</h3>
    <table id="latestOrdersTable">
      <thead><tr><th>Email Guru</th><th>Guru</th><th>Barang</th><th>Kuantiti</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="resetContainer">
      <button class="btn btn-delete" id="resetOrdersBtn">Reset Pesanan Terkini</button>
    </div>

    <!-- Permohonan Baru -->
    <h3>Permohonan Baru</h3>
    <table id="pendingOrdersTable">
      <thead><tr><th>Email Staff</th><th>Staff</th><th>Barang</th><th>Kuantiti</th><th>Tindakan</th></tr></thead>
      <tbody></tbody>
    </table>

    <!-- Permohonan Diluluskan -->
    <h3>Permohonan Diluluskan</h3>
    <table id="approvedOrdersTable">
      <thead><tr><th>Email Staff</th><th>Staff</th><th>Barang</th><th>Kuantiti</th><th>Tindakan</th></tr></thead>
      <tbody></tbody>
    </table>

    <!-- Permohonan Ditolak -->
    <h3>Permohonan Ditolak</h3>
    <table id="rejectedOrdersTable">
      <thead><tr><th>Email Staff</th><th>Staff</th><th>Barang</th><th>Kuantiti</th><th>Tindakan</th></tr></thead>
      <tbody></tbody>
    </table>

    <!-- Stok Barang -->
    <h3>Stok Barang</h3>
    <div style="text-align: right; margin-bottom: 10px;">
      <button id="deleteAllItemsBtn" class="btn btn-delete" onclick="confirmDeleteAllItems()" style="font-size: 14px; padding: 8px 16px;">üóëÔ∏è Hapus Semua Items</button>
    </div>
    <table id="itemsStockTable">
      <thead><tr><th>Nama Barang</th><th>Stok</th><th>Tindakan</th></tr></thead>
      <tbody></tbody>
    </table>

    <!-- Senarai Staff Berdaftar -->
    <h3>Senarai Staff Berdaftar</h3>
    <table id="registeredUsersTable">
      <thead><tr><th>Email Staff</th><th>Nama Staff</th><th>Tarikh Daftar</th><th>Tindakan</th></tr></thead>
      <tbody></tbody>
    </table>

    <a href="admin_stock.html" class="btn btn-undo" style="margin-top:12px;">Urus Stok Barang</a>
    <a href="index.html" class="link">Kembali</a>
  </main>

  <script src="config.js"></script>
  <script>
    // Load and display all tables with latest data from Google Sheets
    async function renderAllTables() {
      console.log('renderAllTables called');
      
      // Show loading state
      showLoadingState();
      
      let orders = [];
      let items = [];
      let users = [];
      
      // PARALLEL LOADING - Fetch all data at once untuk speed up
      if (typeof isConfigured === 'function' && isConfigured()) {
        console.log('Loading data dari Google Sheet (parallel)...');
        
        try {
          const [rawOrders, rawItems, rawUsers] = await Promise.all([
            getTeacherStockRequests().catch(err => { console.error('Orders error:', err); return []; }),
            getItems().catch(err => { console.error('Items error:', err); return []; }),
            getUsers().catch(err => { console.error('Users error:', err); return []; })
          ]);
          
          console.log('Parallel load completed');
          
          // Process orders
          if (rawOrders && rawOrders.length > 0) {
            orders = rawOrders.map(o => ({
              name: o.teacherName || o.name,
              email: o.email,
              item: o.item,
              qty: o.qty,
              status: o.status,
              date: o.date
            }));
            localStorage.setItem('orders', JSON.stringify(orders));
          }
          
          // Process items
          if (rawItems && rawItems.length > 0) {
            items = rawItems;
            localStorage.setItem('itemsStock', JSON.stringify(items));
          }
          
          // Process users
          if (rawUsers && rawUsers.length > 0) {
            users = rawUsers;
            localStorage.setItem('users', JSON.stringify(users));
          }
          
        } catch (error) {
          console.error('Parallel loading error:', error);
        }
      }
      
      // Fallback ke localStorage
      if (!orders || orders.length === 0) {
        console.log('Using localStorage for orders');
        orders = JSON.parse(localStorage.getItem('orders') || '[]');
      }
      if (!items || items.length === 0) {
        console.log('Using localStorage for items');
        items = JSON.parse(localStorage.getItem('itemsStock') || '[]');
      }
      if (!users || users.length === 0) {
        console.log('Using localStorage for users');
        users = JSON.parse(localStorage.getItem('users') || '[]');
      }
      
      console.log('Data ready:', { orders: orders.length, items: items.length, users: users.length });

      // Order Terkini
      const latestTbody = document.querySelector('#latestOrdersTable tbody');
      latestTbody.innerHTML = '';
      orders.slice(0,5).forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${o.email}</td><td>${o.name}</td><td>${o.item}</td><td>${o.qty}</td><td>${o.status}</td>`;
        latestTbody.appendChild(tr);
      });

      document.getElementById('resetContainer').style.display = orders.length > 0 ? 'block' : 'none';

      // Permohonan Baru
      const pendingTbody = document.querySelector('#pendingOrdersTable tbody');
      pendingTbody.innerHTML = '';
      orders.forEach((o, idx) => {
        if(o.status==='pending'){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${o.email}</td><td>${o.name}</td><td>${o.item}</td><td>${o.qty}</td>
            <td>
              <button class="btn-approve" data-email="${o.email}" data-item="${o.item}">Approve</button>
              <button class="btn-reject" data-email="${o.email}" data-item="${o.item}">Reject</button>
              <button class="btn-delete-order" data-email="${o.email}" data-item="${o.item}" style="background: linear-gradient(90deg,#d32f2f 60%,#f44336 100%);">Delete</button>
            </td>`;
          pendingTbody.appendChild(tr);
        }
      });

      // Approved Orders
      const approvedTbody = document.querySelector('#approvedOrdersTable tbody');
      approvedTbody.innerHTML = '';
      orders.forEach((o, idx) => {
        if(o.status==='approved'){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${o.email}</td><td>${o.name}</td><td>${o.item}</td><td>${o.qty}</td>
            <td><button class="btn-undo" data-email="${o.email}" data-item="${o.item}">Undo</button></td>`;
          approvedTbody.appendChild(tr);
        }
      });

      // Rejected Orders
      const rejectedTbody = document.querySelector('#rejectedOrdersTable tbody');
      rejectedTbody.innerHTML = '';
      orders.forEach((o, idx) => {
        if(o.status==='rejected'){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${o.email}</td><td>${o.name}</td><td>${o.item}</td><td>${o.qty}</td>
            <td><button class="btn-undo" data-email="${o.email}" data-item="${o.item}">Undo</button></td>`;
          rejectedTbody.appendChild(tr);
        }
      });

      // Items Stock
      const itemsTbody = document.querySelector('#itemsStockTable tbody');
      itemsTbody.innerHTML = '';
      items.forEach((item, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${item.name}</td><td>${item.stock}</td>
          <td>
            <button class="btn-add" onclick="addStock(${idx})">Tambah</button>
            <button class="btn-delete" onclick="deleteStockItem(${idx})">Hapus</button>
          </td>`;
        itemsTbody.appendChild(tr);
      });

      // Attach click event listeners to all action buttons
      
      // Approve button - move order from pending to approved
      document.querySelectorAll('.btn-approve').forEach(btn=>{ 
        btn.onclick = async (e)=>{ 
          const originalText = btn.innerHTML;
          try {
            btn.disabled = true;
            btn.innerHTML = '<span class="loading">‚óè</span>';
            const email = btn.dataset.email;
            const item = btn.dataset.item;
            await changeStatus(email, item, 'approved');
          } catch (error) {
            console.error('Error approving:', error);
            btn.disabled = false;
            btn.innerHTML = originalText;
          }
        }; 
      });
      document.querySelectorAll('.btn-reject').forEach(btn=>{ 
        btn.onclick = async (e)=>{ 
          const email = btn.dataset.email;
          const item = btn.dataset.item;
          
          // Ask for reason before rejecting
          const reason = prompt("Sila masukkan alasan penolakan permohonan ini:");
          if (!reason || reason.trim() === "") {
            alert("Alasan diperlukan untuk menolak permohonan.");
            return;
          }
          
          const originalText = btn.innerHTML;
          try {
            btn.disabled = true;
            btn.innerHTML = '<span class="loading">‚óè</span>';
            await changeStatus(email, item, 'rejected', reason.trim());
          } catch (error) {
            console.error('Error rejecting:', error);
            btn.disabled = false;
            btn.innerHTML = originalText;
          }
        }; 
      });
      document.querySelectorAll('.btn-undo').forEach(btn=>{ 
        btn.onclick = async (e)=>{ 
          const originalText = btn.innerHTML;
          try {
            btn.disabled = true;
            btn.innerHTML = '<span class="loading">‚óè</span>';
            const email = btn.dataset.email;
            const item = btn.dataset.item;
            await changeStatus(email, item, 'pending');
          } catch (error) {
            console.error('Error undoing:', error);
            btn.disabled = false;
            btn.innerHTML = originalText;
          }
        }; 
      });
      document.querySelectorAll('.btn-delete-order').forEach(btn=>{ 
        btn.onclick = async (e)=>{ 
          const originalText = btn.innerHTML;
          try {
            btn.disabled = true;
            btn.innerHTML = '<span class="loading">‚óè</span>';
            const email = btn.dataset.email;
            const item = btn.dataset.item;
            await deleteOrderFromDashboard(email, item);
          } catch (error) {
            console.error('Error deleting:', error);
            btn.disabled = false;
            btn.innerHTML = originalText;
          }
        }; 
      });

      // Display registered users list
      // Render Registered Users
      renderRegisteredUsers(users);
      
      // Hide loading overlay
      hideLoadingState();
    }
    
    function showLoadingState() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'flex';
    }
    
    function hideLoadingState() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'none';
    }

    async function changeStatus(email, item, status, reason = ""){
      try {
        if (typeof isConfigured !== 'function' || !isConfigured()) {
          alert('Google Sheet tidak dikonfigurasi.');
          return;
        }
        
        console.log('Starting changeStatus:', {email, item, status, reason});
        
        // Call Google Apps Script with reason if rejecting
        const result = await updateRequestStatus(email, item, status, reason);
        console.log('updateRequestStatus result:', result);
        
        if (!result) {
          alert('Ralat: Tiada response dari server.');
          return;
        }
        
        if (!result.success) {
          alert('Ralat: ' + (result.message || 'Tidak dapat update status.'));
          return;
        }
        
        // Success - wait for Google Sheets to sync
        console.log('Operation successful, waiting for sync...');
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Refresh data
        console.log('Refreshing tables...');
        await renderAllTables();
        
        // Show success message
        let msg = 'Berhasil.';
        if(status === 'approved') msg = 'Order diluluskan.';
        else if(status === 'rejected') msg = 'Order ditolak dengan alasan: ' + reason;
        else if(status === 'pending') msg = 'Order dikembalikan ke pending.';
        alert(msg);
        
      } catch (error) {
        console.error('changeStatus error:', error);
        alert('Ralat: ' + (error.message || 'Unknown error'));
      }
    }

    async function deleteOrderFromDashboard(email, item){
      if(!confirm('Anda pasti mahu delete order ini?')){
        return;
      }
      
      try {
        if (typeof isConfigured !== 'function' || !isConfigured()) {
          alert('Google Sheet tidak dikonfigurasi.');
          return;
        }
        
        console.log('Deleting order:', {email, item});
        
        // Call deleteOrder with null date to delete from Pending sheet
        const result = await deleteOrder(email, item, null);
        console.log('deleteOrder result:', result);
        
        if (!result || !result.success) {
          alert('Ralat: ' + (result?.message || 'Tidak dapat delete order.'));
          return;
        }
        
        // Success - wait for sync
        console.log('Order deleted successfully, waiting for sync...');
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Refresh data
        console.log('Refreshing tables...');
        await renderAllTables();
        
        alert('Order berjaya dihapus.');
        
      } catch (error) {
        console.error('deleteOrderFromDashboard error:', error);
        alert('Ralat: ' + (error.message || 'Unknown error'));
      }
    }

    async function resetOrders(){
      if(!confirm('Anda pasti mahu reset semua order? Ini akan delete dari Google Sheet juga!')){
        return;
      }
      
      try {
        // Delete dari Google Sheet jika configured
        if (typeof isConfigured === 'function' && isConfigured()) {
          console.log('Deleting all orders from Google Sheet...');
          const result = await deleteAllOrders();
          console.log('Delete result:', result);
          
          if (!result || !result.success) {
            alert('Ralat memadam dari perkhidmatan: ' + (result?.message || 'Unknown error'));
            return;
          }
        }
        
        // Clear localStorage
        localStorage.removeItem('orders');
        console.log('Cleared orders from localStorage');
        
        // Refresh
        await renderAllTables();
        alert('Semua orders berjaya dihapus.');
        
      } catch (error) {
        console.error('resetOrders error:', error);
        alert('Ralat: ' + error.message);
      }
    }

    async function addStock(idx){
      const items = JSON.parse(localStorage.getItem('itemsStock') || '[]');
      const itemName = items[idx].name;
      const currentStock = items[idx].stock;
      const qty = parseInt(prompt(`Masukkan kuantiti untuk tambah stok ${itemName}:`, '1'));
      
      if(!isNaN(qty) && qty > 0){ 
        const newStock = currentStock + qty;
        
        // Update ke Google Sheet jika configured
        if (typeof isConfigured === 'function' && isConfigured()) {
          const result = await updateItem(itemName, newStock);
          if (result.success) {
            // Update localStorage juga
            items[idx].stock = newStock;
            localStorage.setItem('itemsStock', JSON.stringify(items));
            renderAllTables();
            alert('Stok telah dikemaskini dalam sistem.');
          } else {
            alert('Ralat: ' + (result.message || 'Tidak dapat kemaskini stok.'));
          }
        } else {
          // Fallback ke localStorage jika Google Sheet belum setup
          items[idx].stock = newStock;
          localStorage.setItem('itemsStock', JSON.stringify(items));
          renderAllTables();
          alert('Stok telah dikemaskini.');
        }
      }
    }

    async function deleteStockItem(idx) {
      const items = JSON.parse(localStorage.getItem('itemsStock') || '[]');
      const itemName = items[idx].name;
      if (!confirm(`Hapus item "${itemName}"? Tindakan ini tidak boleh dibatalkan!`)) return;
      
      console.log('=== DELETE STOCK ITEM START ===');
      console.log('Deleting item:', itemName);
      
      // Delete from localStorage
      items.splice(idx, 1);
      if (items.length === 0) {
        localStorage.removeItem('itemsStock');
        console.log('‚úì localStorage cleared (no items left)');
      } else {
        localStorage.setItem('itemsStock', JSON.stringify(items));
        console.log('‚úì localStorage updated');
      }
      
      await renderAllTables();
      
      // Sync deletion to Google Sheet
      if (typeof isConfigured === 'function' && isConfigured()) {
        try {
          const url = GOOGLE_APPS_SCRIPT_CONFIG.webAppUrl + 
                      '?action=deleteItem&name=' + encodeURIComponent(itemName) + 
                      '&timestamp=' + Date.now();
          console.log('Syncing deletion to Google Sheet...');
          const response = await fetch(url, {
            method: 'GET',
            redirect: 'follow',
            cache: 'no-cache'
          });
          const text = await response.text();
          console.log('Delete response:', text);
          
          // Verify deletion after 1 second
          setTimeout(async () => {
            console.log('Verifying deletion...');
            const freshItems = await getItems();
            if (freshItems && freshItems.length > 0) {
              localStorage.setItem('itemsStock', JSON.stringify(freshItems));
            } else {
              localStorage.removeItem('itemsStock');
            }
            await renderAllTables();
            console.log('‚úì Verification complete');
          }, 1000);
        } catch (error) {
          console.error('‚úó Error deleting from Google Sheet:', error);
        }
      }
      
      console.log('=== DELETE STOCK ITEM END ===');
    }
    
    async function confirmDeleteAllItems() {
      const items = JSON.parse(localStorage.getItem('itemsStock') || '[]');
      if (items.length === 0) {
        alert('Tiada item untuk dihapus.');
        return;
      }
      
      if (!confirm(`Hapus SEMUA ${items.length} items? Tindakan ini tidak boleh dibatalkan!`)) return;
      
      console.log('=== DELETE ALL ITEMS START ===');
      const btn = document.getElementById('deleteAllItemsBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = 'Memproses... <span class="loading">‚óè</span>';
      
      // Clear localStorage immediately
      localStorage.removeItem('itemsStock');
      console.log('‚úì localStorage cleared');
      await renderAllTables();
      
      // Delete from Google Sheet one by one
      if (typeof isConfigured === 'function' && isConfigured()) {
        console.log('Deleting', items.length, 'items from Google Sheet...');
        for (let i = 0; i < items.length; i++) {
          try {
            const itemName = items[i].name;
            const url = GOOGLE_APPS_SCRIPT_CONFIG.webAppUrl + 
                        '?action=deleteItem&name=' + encodeURIComponent(itemName) + 
                        '&timestamp=' + Date.now();
            await fetch(url, {
              method: 'GET',
              redirect: 'follow',
              cache: 'no-cache'
            });
            console.log(`‚úì Deleted ${i + 1}/${items.length}: ${itemName}`);
            
            // Small delay to prevent server overload
            await new Promise(resolve => setTimeout(resolve, 200));
          } catch (error) {
            console.error('Error deleting item:', items[i].name, error);
          }
        }
        
        // Verify after 2 seconds
        setTimeout(async () => {
          console.log('Verifying deletion...');
          const freshItems = await getItems();
          if (freshItems && freshItems.length > 0) {
            localStorage.setItem('itemsStock', JSON.stringify(freshItems));
          } else {
            localStorage.removeItem('itemsStock');
          }
          await renderAllTables();
          console.log('‚úì All items deleted and verified');
        }, 2000);
      }
      
      btn.disabled = false;
      btn.innerHTML = originalText;
      alert('Semua item berjaya dihapus!');
      console.log('=== DELETE ALL ITEMS END ===');
    }

    // Paparkan semua staff berdaftar dari Google Sheet atau localStorage
    async function renderRegisteredUsers(users = []){
      const tbody = document.querySelector('#registeredUsersTable tbody');
      tbody.innerHTML = '';

      if(users.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4">Tiada staff berdaftar.</td>`;
        tbody.appendChild(tr);
      } else {
        users.forEach(user => {
          const tr = document.createElement('tr');
          const registrationDate = user.registrationDate || 'N/A';
          tr.innerHTML = `<td>${user.email}</td><td>${user.name}</td><td>${registrationDate}</td>
            <td>
              <button class="btn btn-delete" onclick="confirmDeleteUser('${user.email}', '${user.name}')">Hapus</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }
    }

    // Confirm sebelum delete user
    function confirmDeleteUser(email, name) {
      if (confirm(`Adakah anda pasti mahu padam staff "${name}" (${email})? Tindakan ini tidak boleh dibatalkan.`)) {
        deleteUserFromSheet(email);
      }
    }

    // Delete user dari Google Sheet
    async function deleteUserFromSheet(email) {
      console.log('=== DELETE USER START ===');
      console.log('Email:', email);
      
      const result = await deleteUser(email);
      console.log('Delete result:', result);
      
      if (result && result.success) {
        // Padam dari localStorage juga
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        const beforeCount = users.length;
        users = users.filter(u => u.email.toLowerCase() !== email.toLowerCase());
        const afterCount = users.length;
        
        if (users.length > 0) {
          localStorage.setItem('users', JSON.stringify(users));
        } else {
          localStorage.removeItem('users');
        }
        
        console.log(`‚úì Deleted from localStorage: ${beforeCount} -> ${afterCount} users`);
        
        alert('Staff berjaya dipadam.');
        
        // Refetch fresh data from Google Sheet
        setTimeout(async () => {
          const freshUsers = await getUsers();
          if (freshUsers && freshUsers.length > 0) {
            localStorage.setItem('users', JSON.stringify(freshUsers));
          } else {
            localStorage.removeItem('users');
          }
          await renderRegisteredUsers(freshUsers);
          console.log('‚úì User list refreshed');
        }, 1000);
      } else {
        console.error('Delete failed:', result);
        alert('Ralat: ' + (result ? result.message : 'Tidak dapat memadamkan staff.'));
      }
      
      console.log('=== DELETE USER END ===');
    }

    renderAllTables();

    // Auto-refresh setup
    let autoRefreshInterval = null;
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    const refreshDataBtn = document.getElementById('refreshDataBtn');
    
    function startAutoRefresh() {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      autoRefreshInterval = setInterval(() => {
        console.log('Auto-refreshing data...');
        renderAllTables().catch(err => console.error('Auto-refresh error:', err));
      }, 30000); // Refresh every 30 seconds
    }
    
    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }
    
    // Auto-refresh toggle
    autoRefreshToggle.addEventListener('change', (e) => {
      if (e.target.checked) {
        console.log('Auto-refresh enabled');
        startAutoRefresh();
      } else {
        console.log('Auto-refresh disabled');
        stopAutoRefresh();
      }
    });
    
    // Manual refresh button
    refreshDataBtn.addEventListener('click', async () => {
      refreshDataBtn.disabled = true;
      refreshDataBtn.innerHTML = 'üîÑ Menyegarkan... <span class="loading">‚óè</span>';
      try {
        await renderAllTables();
        refreshDataBtn.innerHTML = '‚úì Segarkan Selesai';
        setTimeout(() => {
          if (refreshDataBtn) refreshDataBtn.innerHTML = 'üîÑ Segarkan Data';
        }, 2000);
      } catch (error) {
        console.error('Refresh error:', error);
        refreshDataBtn.innerHTML = '‚ùå Ralat';
      } finally {
        refreshDataBtn.disabled = false;
        if (refreshDataBtn.innerHTML === '‚ùå Ralat') {
          setTimeout(() => {
            if (refreshDataBtn) refreshDataBtn.innerHTML = 'üîÑ Segarkan Data';
          }, 2000);
        }
      }
    });

    // Reset Orders button with loading state
    document.getElementById('resetOrdersBtn').addEventListener('click', async (e) => {
      const resetBtn = e.target;
      const originalText = resetBtn.innerHTML;
      
      if(!confirm('Anda pasti mahu reset semua order?!')){
        return;
      }
      
      try {
        // Show loading state
        resetBtn.disabled = true;
        resetBtn.innerHTML = 'Memproses... <span class="loading">‚óè</span>';
        
        // Delete dari Google Sheet jika configured
        if (typeof isConfigured === 'function' && isConfigured()) {
          console.log('Deleting all orders from Google Sheet...');
          const result = await deleteAllOrders();
          console.log('Delete result:', result);
          
          if (!result || !result.success) {
            alert('Ralat hapus dari Google Sheet: ' + (result?.message || 'Unknown error'));
            return;
          }
        }
        
        // Clear localStorage
        localStorage.removeItem('orders');
        console.log('Cleared orders from localStorage');
        
        // Refresh
        await renderAllTables();
        alert('Semua orders berjaya dihapus.');
        
      } catch (error) {
        console.error('resetOrders error:', error);
        alert('Ralat: ' + error.message);
      } finally {
        // Always restore button state
        resetBtn.disabled = false;
        resetBtn.innerHTML = originalText;
      }
    });
  </script>
</body>
</html>
